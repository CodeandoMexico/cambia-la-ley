<style>
li.title {
  margin-left: 0px;
}
li.chapter {
  margin-left: 50px;
}
li.section {
  margin-left: 100px;
}
li.article_under_chapter {
  margin-left: 100px;
}
li.article_under_section {
  margin-left: 150px;
}
</style>

<script type="text/javascript">

/****************************************************************
| This code manages some actions regarding to a law's division. |
| It is included in this specific view since no other needs it. |
****************************************************************/

// Hold article, law, and tag objects. Their ID is the key.
var article_under_section_dict = {};
var article_under_chapter_dict = {};
var section_dict               = {};
var chapter_dict               = {};
var title_dict                 = {};
var law_dict                   = {};
var tag_dict                   = {};
structurizeData();

/*
 * Puts in a dictionary all of the articles, laws, and tags, titles, chapters,
 * and sections related to this law.
 */
function structurizeData() {
  var articles_under_section = <%- JSON.stringify(articles_under_section) %>;
  var articles_under_chapter = <%- JSON.stringify(articles_under_chapter) %>;
  var sections               = <%- JSON.stringify(sections) %>;
  var chapters               = <%- JSON.stringify(chapters) %>;
  var titles                 = <%- JSON.stringify(titles) %>;

  articles_under_section.map(function(article) {
    article_under_section_dict[article.id] = article;
  });

  articles_under_chapter.map(function(article) {
    article_under_chapter_dict[article.id] = article;
  });

  sections.map(function(section) {
    section_dict[section.id] = section;
  });

  chapters.map(function(chapter) {
    chapter_dict[chapter.id] = chapter;
  });

  titles.map(function(title) {
    title_dict[title.id] = title;
  });

}

function getUrl(article_number) {
  var tagged = <%= typeof(tag) !== 'undefined' %>;
  var url = '';
  if (tagged) {
  } else {
    url = '/ley/<%= law.slug %>/articulo/' + article_number;
  }
  return url;
}

function getLi(entity_type, obj) {
  var html = ''
  if (entity_type == 'article_under_section' || entity_type == 'article_under_chapter') {
    html += '<li class="' + entity_type + '">';
    html +=   '<a href="' + getUrl(obj.number) + '" target="_blank">';
    html +=     'Artículo ' + obj.number;
    html +=   '</a>';
    html += '</li>';
  } else if (entity_type == 'title') {
    html += '<li class="' + entity_type + '">';
    html +=   obj.heading;
    html +=   "&nbsp;<a onclick='prepareTitleModal(\"edit\"," + JSON.stringify(obj) + ")'><i class='fa fa-pencil'></i></a>";
    html +=   "&nbsp;<a onclick='destroyLawDivisionEntity(\"title\"," + obj.id + ")'><i class='fa fa-trash-o'></i></a>";
    html +=   "&nbsp;<button class='pure-button'><i class='fa fa-plus'></i> capítulo</button>";
    html += '</li>';
  }
  return html;
}

/*
 * Builds index according to this law's divisions.
 */ 
function buildIndex() {
  var index_dom = document.getElementById('index');
  var html = '';
  for (i in title_dict) {
    html += getLi('title', title_dict[i]);
    for (j in chapter_dict) {
      if (chapter_dict[j].title == title_dict[i].id) {
        html += getLi('chapter', chapter_dict[j]);
        for (k in section_dict) {
          if (section_dict[k].chapter == chapter_dict[j].id) {
            html += getLi('section', section_dict[k]);
            for (l in article_under_section_dict) {
              if (article_under_section_dict[l].section == section_dict[k].id) {
                html += getLi('article_under_section', article_under_section_dict[l]);
              }
            }
          }
        }
        for (kk in article_under_chapter_dict) {
          if (article_under_chapter_dict[kk].chapter == chapter_dict[j].id) {
            html += getLi('article_under_chapter', article_under_chapter_dict[kk]);
          }
        }
      }
    }
  }

  if (html != '') {
    index_dom.innerHTML = '<ul>' + html + '</ul>';
  }
}

/*
 * Having an array with the IDs of the notifications being shown in this view,
 * call the notification's controller to mark them as "seen".
 */
function markNotificationsAsSeen() {
/*
  $.ajax({
    url: '/notificaciones/marca_como_vistas',
    method: 'POST',
    data: {},
  }).done(function(data, textStatus, jqXHR) {
    if (textStatus == 'success') {
      $('.unseen-notification').each(function() {

        // Change color to white.
        $(this).animate({backgroundColor: '#fff'}, 'slow');

        // Decrease navbar notification count by 1.
        var dom_navbar_notifications_badge         = document.getElementById('navbar-notifications-badge');
        var dom_navbar_notifications_counter       = document.getElementById('navbar-notifications-counter');
        dom_navbar_notifications_counter.innerHTML = parseInt(dom_navbar_notifications_counter.innerHTML, 10) - 1;

        if (parseInt(dom_navbar_notifications_counter.innerHTML, 10) == 0) {
          dom_navbar_notifications_badge.className = 'pure-badge';
        }

      });
    }
  });
*/
}

</script>

<% var tagged = typeof tag !== 'undefined' %>

<div class="law">
  <header class='header l-box'>
    <h1 class="l-no-margin-b header-title">
      <% if (tagged) { %>
        <u><a href="/reforma/<%= tag.slug %>"><%= tag.name %></a></u>
        <i class="inactive-font fa fa-angle-double-right"></i>
      <% } %>
      <span class="inactive-font"><%= law.name %></span>
    </h1>
    <% if (req.session.user && req.session.user.role == 'admin') { %>
      <% var origin = tagged ? ('/reforma/' + tag.slug) : ('/') %>
      <%-
        partial('../modules/_admin_buttons',{
          gui_id : law.slug,
          db_id  : law.id,
          origin : origin,
          model  : 'law'
        })
      %>
    <% } %>
    <h2 class='header-subtitle'><%= law.summary %></h2>
  </header>

  <h3 class='l-box l-no-margin'>Índice</h3>

  <% if (req.session.user && req.session.user.role == 'admin') { %>
    <div class='l-box l-no-margin'>
      <%- partial('../modules/_index_builder') %>
    </div>
  <% } %>

  <div id="index" class='l-box l-no-margin'>
    Aún no se ha construido el índice para esta ley.
  </div>

</div>

<script type="text/javascript">
  buildIndex();
</script>
